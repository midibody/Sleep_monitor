Snoring Detection and Vibration Feedback
---
The purpose is to detect sustained snoring sounds during sleep and trigger a vibration alert that encourages the sleeper to change position or briefly wake up, reducing or stopping snoring episodes.

Overall principle
---
The system continuously monitors ambient sound using the onboard PDM microphone.
Instead of reacting to raw sound peaks, it estimates a short-term sound energy (volume) and compares it against adaptive thresholds that follow the background noise level.

To avoid false detections caused by movements, handling noise, or body shifts, audio detection is gated by motion analysis using inertial sensor data.
Only sound events that occur while the body is relatively still are considered valid snoring candidates.

When repeated snoring events occur within a defined time window, the system triggers a vibration pattern via a motor to prompt a physical response from the sleeper.

Audio acquisition and volume estimation
---
The microphone operates in mono PDM mode at 16 kHz, which is sufficient for snoring detection while keeping power consumption reasonable.

Audio samples are collected in short buffers and processed as follows:

A DC offset is continuously estimated and removed to compensate for microphone bias.

The signal amplitude is converted to an absolute value and averaged over the buffer.

The result is a single volume metric representing the sound energy of the current time slice.

This approach is intentionally simple and robust, prioritizing stability and low power over spectral analysis.

Adaptive noise tracking
---
Sleep environments are rarely silent. Ventilation systems, fabric movement, or distant traffic can raise the noise floor.

To handle this, the system maintains a rolling estimate of:

the average background volume

the short-term variation of that volume

When the environment is stable, detection thresholds are automatically shifted upward or downward relative to the current noise floor.
This allows the detector to remain sensitive to snoring while ignoring constant or slowly varying background sounds.

Snoring event detection
---
A snoring event is not triggered by a single loud buffer.
Instead, detection is based on temporal consistency:

Sound must exceed a high adaptive threshold for several consecutive frames.

Once an event starts, it remains active until the volume drops below a lower threshold for a sufficient duration (hysteresis).

This prevents rapid oscillation and avoids reacting to impulsive noises such as clicks, coughs, or short speech fragments.

Each validated event is counted as a snoring occurrence.

Motion gating (false positive rejection)
---
Audio detection is automatically disabled during body movement.

Using gyroscope data, the system continuously estimates the magnitude of angular motion.
If motion exceeds a defined threshold:

Any ongoing snoring event is cancelled

Audio detection is temporarily ignored

Counters are reset

This ensures that sounds generated by posture changes, bedding friction, or handling do not trigger false snoring alerts.

Snoring aggregation and alert logic
---
The device does not vibrate on every snoring sound.

Instead:

Snoring events are aggregated over time

Only if several events occur within a defined time window is an alert considered meaningful

When the aggregation threshold is reached:

A vibration sequence is triggered using the motor

Counters are reset

A cooldown period prevents immediate retriggering

This strategy avoids excessive stimulation while still reacting to persistent snoring patterns.

